syntax = "proto3";
package deriva;

service Deriva {
  rpc PutLeaf (PutLeafRequest) returns (PutLeafResponse);
  rpc PutRecipe (PutRecipeRequest) returns (PutRecipeResponse);
  rpc Get (GetRequest) returns (stream GetResponse);
  rpc Resolve (ResolveRequest) returns (ResolveResponse);
  rpc Invalidate (InvalidateRequest) returns (InvalidateResponse);
  rpc CascadeInvalidate (CascadeInvalidateRequest) returns (CascadeInvalidateResponse);
  rpc Status (StatusRequest) returns (StatusResponse);
  rpc Verify (VerifyRequest) returns (VerifyResponse);
}

message PutLeafRequest { bytes data = 1; }
message PutLeafResponse { bytes addr = 1; }

message PutRecipeRequest {
  string function_name = 1;
  string function_version = 2;
  repeated bytes inputs = 3;
  map<string, string> params = 4;
}
message PutRecipeResponse { bytes addr = 1; }

message GetRequest { bytes addr = 1; }
message GetResponse { bytes chunk = 1; }

message ResolveRequest { bytes addr = 1; }
message ResolveResponse {
  bool found = 1;
  string function_name = 2;
  string function_version = 3;
  repeated bytes inputs = 4;
  map<string, string> params = 5;
}

message InvalidateRequest {
  bytes addr = 1;
  bool cascade = 2;
}
message InvalidateResponse {
  bool was_cached = 1;
  uint64 evicted_count = 2;
}

message CascadeInvalidateRequest {
  bytes addr = 1;
  string policy = 2;
  bool include_root = 3;
  bool detail_addrs = 4;
}
message CascadeInvalidateResponse {
  uint64 evicted_count = 1;
  uint64 traversed_count = 2;
  uint32 max_depth = 3;
  uint64 bytes_reclaimed = 4;
  repeated bytes evicted_addrs = 5;
  uint64 duration_micros = 6;
}

message StatusRequest {}
message StatusResponse {
  uint64 recipe_count = 1;
  uint64 blob_count = 2;
  uint64 cache_entries = 3;
  uint64 cache_size_bytes = 4;
  double cache_hit_rate = 5;
  string verification_mode = 6;
  uint64 verification_total = 7;
  uint64 verification_passed = 8;
  uint64 verification_failed = 9;
  double verification_failure_rate = 10;
}

message VerifyRequest {
  bytes addr = 1;
}

message VerifyResponse {
  bool deterministic = 1;
  string output_hash = 2;
  uint64 output_size = 3;
  uint64 compute_time_us = 4;
  string error = 5;
}
